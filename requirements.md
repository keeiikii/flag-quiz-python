# 国旗クイズゲーム - 要件定義書

## プロジェクト概要
Gemini 2.0 Flash APIを中核とした国旗クイズWebアプリケーション。AIが国の選択、回答判定、質問応答、ヒント生成のすべてを担当し、ユーザーは国旗を見て国名を当てるゲームを楽しむことができます。

## 技術仕様

### 使用技術
- **バックエンド**: Flask (Python)
- **フロントエンド**: HTML + CSS (グラスモーフィズムデザイン)
- **AI API**: Google Gemini 2.0 Flash（メイン処理）
- **国旗データ**: flagcdn.com（画像配信）
- **フォント**: Poppins + Playfair Display

### システム要件
- Python 3.7以上
- Flask 2.3.3
- google-generativeai 0.3.2
- Gemini API キー（環境変数 `GEMINI_API_KEY`）

## 機能要件

### 1. ゲーム基本仕様
- **対象国**: 国連加盟193カ国
- **回答制限**: 各問題につき2回まで回答可能
- **質問制限**: 各問題につき10回まで質問可能
- **ヒント制限**: 各問題につき3種類のヒント（主食・面積・言語）

### 2. ゲームフロー

#### 2.1 ゲーム開始
- Gemini APIが国連加盟193カ国からランダムに1カ国を選択
- 日本語国名、英語国名、国旗URLを生成
- セッションに国情報を保存

#### 2.2 ゲームプレイ
- **国旗表示**: 選択された国の国旗を表示
- **統計表示**: 残り回答回数、残り質問回数、残りヒント回数を表示
- **質問機能**: はい/いいえ形式の質問をAIに投げかけ可能
- **ヒント機能**: 3種類のヒント（主食・面積・言語）を取得可能
- **回答機能**: 日本語で国名を回答（AIが柔軟に判定）

#### 2.3 ゲーム終了
- **正解時**: 正解メッセージを表示してゲーム終了
- **不正解時**: 回答回数が残っていれば継続、なければゲーム終了
- **終了時**: 正解の国名を日本語で表示

### 3. AI機能仕様

#### 3.1 国生成システム
- **機能**: 国連加盟193カ国からランダム選択
- **出力**: テキスト形式（日本語国名、英語国名、国コード）
- **国旗URL**: flagcdn.com の2文字国コードを使用
- **フォールバック**: API失敗時は事前定義された10カ国からランダム選択
- **制約**: 実在する国連加盟国のみ

#### 3.2 回答判定システム
- **入力**: プレイヤーの日本語回答
- **判定ロジック**: 
  1. 厳密な文字列マッチング（優先）
  2. AIによる柔軟判定（フォールバック）
- **AI判定条件**: 実質的同義性、一般的略称、表記ゆれのみ正解
- **厳格性**: 地域名・都市名・曖昧表現は不正解
- **出力**: 「正解」または「不正解」

#### 3.3 質問回答システム
- **入力**: プレイヤーからのはい/いいえ形式の質問
- **出力**: 「はい」または「いいえ」の日本語回答
- **制約**: 国名、首都名、地域名の直接言及禁止

#### 3.4 ヒントシステム
- **主食ヒント**: その国の代表的な主食について50文字以内で説明
- **面積ヒント**: 日本との面積比較を50文字以内で説明
- **言語ヒント**: 公用語について50文字以内で説明
- **制約**: 国名、地域名の直接言及禁止

### 4. データ仕様

#### 4.1 セッション管理
```python
session = {
    'game_started': bool,           # ゲーム開始フラグ
    'current_country': str,         # 英語国名（AI処理用）
    'current_country_jp': str,      # 日本語国名（表示用）
    'country_flag': str,            # 国旗画像URL
    'answers_left': int,            # 残り回答回数（初期値: 2）
    'questions_left': int,          # 残り質問回数（初期値: 10）
    'hints_used': list,             # 使用済みヒント種類
    'question_log': list,           # 質問履歴
    'current_hint': str             # 現在表示中のヒント
}
```

## 非機能要件

### 1. ユーザビリティ
- **デザイン**: モダンなグラスモーフィズムデザイン
- **レスポンシブ**: スマートフォン・タブレット・PC対応
- **言語**: 完全日本語対応
- **操作性**: 直感的で分かりやすいUI

### 2. パフォーマンス
- **AI応答時間**: 通常3-5秒以内（国生成、回答判定、質問応答、ヒント生成）
- **画像読み込み**: flagcdn.com からの国旗画像高速配信
- **セッション管理**: 効率的なメモリ使用

### 3. セキュリティ・可用性
- **API保護**: 環境変数によるAPIキー管理
- **入力検証**: 全入力データの適切なバリデーション
- **セッション**: Flask標準のセッション管理
- **フォールバック**: API障害時の代替機能（事前定義国リスト）

## エラーハンドリング仕様

### 1. API通信エラー
- **Gemini API初期化失敗**: アプリケーション起動時にエラーメッセージ表示後終了
- **国生成API失敗**: フォールバック国リストからランダム選択
- **質問回答API失敗**: エラーメッセージ表示、ゲーム継続
- **ヒント生成API失敗**: エラーメッセージ表示、ゲーム継続
- **回答判定API失敗**: 不正解として処理、ゲーム継続

### 2. セッション管理エラー
- **セッションデータ不整合**: ホームページにリダイレクト
- **ゲーム未開始状態でのアクセス**: 適切なエラーメッセージ表示
- **セッションクリア失敗**: エラーを無視してリセット続行

### 3. ユーザー入力エラー
- **空の質問/回答**: 入力を促すメッセージ表示
- **制限回数超過**: 制限到達メッセージ表示
- **無効なヒント種類**: エラーメッセージ表示
- **既使用ヒント再要求**: 使用済みメッセージ表示

### 4. システムエラー
- **環境変数未設定**: 起動時にエラーメッセージ表示後終了
- **テンプレートファイル不在**: Flask標準エラーページ表示
- **国旗画像読み込み失敗**: ブラウザの標準代替画像表示

## 制約事項

### 1. 技術制約
- Gemini APIの利用制限に準拠
- flagcdn.com の画像配信サービスに依存
- JavaScriptを使用しない（学習目的のため）
- 単一AI APIへの集中依存

### 2. 機能制約
- **回答形式**: 日本語国名のみ受付（AIが柔軟判定）
- **質問形式**: はい/いいえ形式のみ
- **同時プレイ**: 単一ユーザーのみ対応
- **データ永続化**: なし（セッションベース）

### 3. コンテンツ制約
- **対象国**: 国連加盟国のみ
- **言語**: 日本語のみ対応
- **ヒント**: 事前定義された3種類のみ

## 開発・運用要件

### 1. 開発環境
- Python 3.7+
- Flask開発サーバー
- 環境変数設定必須

### 2. デプロイ要件
- WSGI対応Webサーバー
- SSL/TLS対応推奨
- 環境変数の適切な設定

### 3. 保守要件
- エラーハンドリング
- APIエラー時の適切な処理

## 今後の拡張可能性
- 複数言語対応
- スコアシステム
- ユーザー登録・ログイン機能
- 難易度設定（地域限定、人口規模別など）
- 統計データの永続化
- マルチプレイヤー対応
- AIによる動的ヒント生成（文化、歴史、経済など）
- 音声回答機能